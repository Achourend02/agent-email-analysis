<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analyse Email Gmail</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#0f0f0f;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;color:#e0e0e0}
    .container{background:#1a1a1a;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.8);padding:40px;max-width:800px;width:100%;border:1px solid #2a2a2a}
    h1{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;font-size:28px}
    .subtitle{color:#888;margin-bottom:30px;font-size:14px}
    .button-container{text-align:center;margin-bottom:30px}
    button{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:15px 40px;font-size:16px;font-weight:600;border-radius:50px;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 4px 15px rgba(102,126,234,.4)}
    button:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.6)}
    button:active:not(:disabled){transform:translateY(0)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .loader{border:3px solid #333;border-top:3px solid #667eea;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;display:inline-block;margin-left:10px;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .result{display:none;margin-top:30px;animation:fadeIn .5s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .result.show{display:block}
    .card{background:#242424;border-left:4px solid #667eea;padding:20px;border-radius:8px;margin-bottom:15px;border:1px solid #2a2a2a}
    .card-header{display:flex;align-items:center;margin-bottom:10px}
    .card-icon{width:24px;height:24px;margin-right:10px;opacity:.8;stroke:#667eea}
    .card-title{font-weight:600;color:#e0e0e0;font-size:14px;text-transform:uppercase;letter-spacing:.5px}
    .card-content{color:#b0b0b0;line-height:1.6;font-size:15px}
    .category-badge{display:inline-block;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:600}
    .keywords{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .keyword{background:#1a1a1a;border:2px solid #667eea;color:#667eea;padding:6px 14px;border-radius:15px;font-size:13px;font-weight:500}
    .error{background:#2a1a1a;border-left-color:#e74c3c;border-color:#3a2020}
    .error .card-title{color:#ff6b6b}
    .error .card-content{color:#ff9999}
    .metadata{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
    .metadata-item{background:#242424;padding:12px;border-radius:8px;border:1px solid #2a2a2a}
    .metadata-label{font-size:11px;text-transform:uppercase;color:#666;font-weight:600;margin-bottom:5px;letter-spacing:.5px}
    .metadata-value{font-size:14px;color:#e0e0e0;font-weight:500}
    .origin{display:none}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìß Analyse Email Gmail</h1>
    <p class="subtitle">D√©clenchez le workflow d'analyse du dernier email re√ßu</p>
    <p class="origin">Origine de la page : <code id="origin"></code></p>

    <div class="button-container">
      <button id="triggerBtn" onclick="triggerAnalysis()">
        Analyser le dernier email
        <span id="loader" class="loader" style="display:none;"></span>
      </button>
    </div>

    <div id="result" class="result"></div>
  </div>

<script>
  const WEBHOOK_URL = 'https://mach222.app.n8n.cloud/webhook/trigger-analysis';

  const originEl = document.getElementById('origin');
  if (originEl) {
    originEl.textContent = window.location.origin || 'file:// (non support√©)';
  }

  async function triggerAnalysis() {
    const btn = document.getElementById('triggerBtn');
    const loader = document.getElementById('loader');
    const resultDiv = document.getElementById('result');

    btn.disabled = true;
    if (loader) {
      loader.style.display = 'inline-block';
      btn.textContent = 'Analyse en cours. ';
      btn.appendChild(loader);
    }
    resultDiv.innerHTML = '';
    resultDiv.classList.remove('show');

    try {
      const response = await fetch(WEBHOOK_URL, {
        method: 'POST',
        mode: 'cors',
        cache: 'no-store'
      });

      if (!response.ok) {
        // lire le texte d'erreur du serveur si dispo
        const errText = await safeReadText(response);
        throw new Error(`Erreur HTTP ${response.status}${errText ? ` ‚Äì ${errText}` : ''}`);
      }

      // parse robuste: JSON si possible, sinon texte -> JSON.parse si valide
      const data = await smartParse(response);

      displayResult(normalizeData(data));
    } catch (error) {
      displayError(error.message);
    } finally {
      btn.disabled = false;
      if (loader) loader.style.display = 'none';
      btn.textContent = 'Analyser le dernier email';
    }
  }

  async function smartParse(response) {
    // 204 No Content ou corps vide
    if (response.status === 204) return {};
    const ct = response.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      // peut encore √™tre vide ‚Üí g√©rer proprement
      const text = await response.text();
      if (!text || !text.trim()) return {};
      return JSON.parse(text);
    } else {
      const text = await response.text();
      if (!text || !text.trim()) return {};
      try { return JSON.parse(text); }
      catch { throw new Error(`R√©ponse non-JSON: ${text.slice(0,200)}`); }
    }
  }

  async function safeReadText(response) {
    try { return (await response.text()).slice(0,200); }
    catch { return ''; }
  }

  function normalizeData(raw) {
    // accepte plusieurs formes renvoy√©es par n8n
    if (!raw || typeof raw !== 'object') return {};
    if (raw.status === 'success' && raw.data) return raw.data;
    if (raw.output || raw.category || raw.summary) {
      return {
        from: raw.from,
        subject: raw.subject,
        date: raw.date,
        output: raw.output || {
          category: raw.category,
          summary: raw.summary,
          keywords: raw.keywords
        }
      };
    }
    return raw;
  }

  function displayResult(data) {
    const resultDiv = document.getElementById('result');
    const out = data.output || {};
    const summaryFormatted = formatWithLineBreaks(out.summary || 'Aucun r√©sum√© disponible');
    const keywords = out.keywords || data.keywords || [];
    const keywordsArray = Array.isArray(keywords)
      ? keywords
      : (typeof keywords === 'string' ? keywords.split(',').map(k => k.trim()) : []);

    resultDiv.innerHTML = `
      <div class="metadata">
        <div class="metadata-item">
          <div class="metadata-label">De</div>
          <div class="metadata-value">${escapeHtml(data.from || 'Non sp√©cifi√©')}</div>
        </div>
        <div class="metadata-item">
          <div class="metadata-label">Sujet</div>
          <div class="metadata-value">${escapeHtml(data.subject || 'Sans sujet')}</div>
        </div>
        <div class="metadata-item">
          <div class="metadata-label">Date</div>
          <div class="metadata-value">${formatDate(data.date)}</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <svg class="card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
          </svg>
          <div class="card-title">Cat√©gorie</div>
        </div>
        <div class="card-content">
          <span class="category-badge">${escapeHtml(out.category || data.category || 'Non cat√©goris√©')}</span>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <svg class="card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <div class="card-title">R√©sum√©</div>
        </div>
        <div class="card-content">${summaryFormatted}</div>
      </div>

      ${keywordsArray.length ? `
      <div class="card">
        <div class="card-header">
          <svg class="card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
          </svg>
          <div class="card-title">Mots-cl√©s</div>
        </div>
        <div class="keywords">
          ${keywordsArray.map(k => `<span class="keyword">${escapeHtml(k)}</span>`).join('')}
        </div>
      </div>` : ''}
    `;

    resultDiv.classList.add('show');
  }

  function displayError(message) {
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = `
      <div class="card error">
        <div class="card-header">
          <svg class="card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div class="card-title">Erreur</div>
        </div>
        <div class="card-content">
          Une erreur est survenue : ${escapeHtml(message)}
        </div>
      </div>
    `;
    resultDiv.classList.add('show');
  }

  function formatWithLineBreaks(text) {
    return escapeHtml(text).replace(/\\n/g,'<br>').replace(/\n/g,'<br>');
  }
  function formatDate(dateString) {
    if (!dateString) return 'Non disponible';
    try {
      const date = new Date(dateString);
      return date.toLocaleString('fr-FR',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
    } catch { return dateString; }
  }
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text ?? '';
    return div.innerHTML;
  }
</script>

</body>
</html>
